---
title: "Clusters según emprendimiento, tipología de vivienda y profesionales"
author: "Joaquín Bravo Veas"
date: "`r Sys.Date()`"
output: html_document
---

------------------------------------------------------------------------

# 1. Introducción

El análisis espacial del emprendimiento en áreas urbanas requiere comprender no solo cuántas personas emprenden, sino también cómo las características del territorio moldean este fénomeno. A partir de la información censal y de la Encuesta CASEN, es posible identificar patrones socioeconómicos que no se aprecian en indicadores aislados, pero que emergen con claridad cuando se integran mediante técnicas de microsimulación y análisis territorial. En este estudio se combinan datos del Censo 2017 y la CASEN para estimar variables a escala de zona censal y construir una representación más precisa del comportamiento socioeconómico dentro del Gran Santiago.

La integración de estas fuentes permite observar con mayor detalle cómo se distribuye la actividad emprendedora en la ciudad y cómo se vincula con características estructurales del entorno urbano, como la presencia de población profesional o la tipología predominante de vivienda. A través de métodos de agrupamiento, como el clustering k-means complementado con el método del codo, se identifican configuraciones territoriales que comparten rasgos similares y que reflejan diferentes formas de organización económica y social en la ciudad.

Este enfoque facilita pasar desde un análisis puramente descriptivo hacia una interpretación territorial más profunda, donde se reconocen contrastes espaciales, modos diferenciados de habitar y relaciones entre las características sociales y el tejido urbano. Adicionalmente, se incorpora el cálculo de un índice de Shannon para examinar la variabilidad interna de cada territorio, lo que permite capturar la heterogeneidad presente dentro de las comunas.

En conjunto, este marco analítico, que integra técnicas cuantitativas con herramientas de análisis espacial, entrega una visión más completa sobre cómo se distribuye la actividad económica en el Gran Santiago y de qué manera la estructura urbana influye en las oportunidades, recursos y desigualdades presentes dentro del territorio metropolitano.

## 1.1 Objetivo general

Caracterizar la distribución territorial del emprendimiento en el Gran Santiago mediante la integración de datos de CASEN y Censo 2017, y analizar cómo esta actividad se relaciona con la presencia de población profesional y la tipología de vivienda a nivel de zona censal.

## 1.2 Objetivos especificos

-   Generar estimaciones territoriales del porcentaje de población emprendedora y profesional a partir de técnicas de microsimulación que permiten proyectar los datos de CASEN sobre la estructura poblacional del Censo 2017.

-   Analizar la distribución espacial del emprendimiento y de la población profesional en el área urbana del Gran Santiago mediante herramientas de análisis geográfico.

-   Caracterizar la tipología de vivienda predominante por zona censal y explorar su relación con las dinámicas de emprendimiento y composición socioeducativa.

-   Aplicar métodos de clustering multivariado para identificar grupos de zonas censales con perfiles similares en términos de emprendimiento, estructura residencial y presencia de población profesional.

-   Interpretar los patrones territoriales resultantes, destacando configuraciones urbanas que revelen diferencias en las oportunidades económicas y formas de habitar dentro del territorio metropolitano.

------------------------------------------------------------------------

# 2. Desarrollo

```{r include=FALSE}
################################################################################
## 1) LIBRERÍAS
################################################################################
library(rakeR)
library(RPostgres)
library(DBI)
library(sf)
library(dplyr)
library(data.table)
library(ggplot2)
library(scales)
library(units)
library(RColorBrewer)
library(rlang)
library(stringi)
library(tidyr)
library(grid)
library(cowplot)
library(biscale)

################################################################################
## 2) ENTRADAS Y BASES
################################################################################
ruta_casen <- "D:/usach/geomarketing/rds/casen_rm.rds"
ruta_censo <- "D:/usach/geomarketing/rds/cons_censo_df.rds"
casen_raw  <- readRDS(ruta_casen)
cons_censo_df <- readRDS(ruta_censo)

################################################################################
## 3) PREPROCESO CASEN
################################################################################
col_cons   <- sort(setdiff(names(cons_censo_df), c("GEOCODIGO","COMUNA")))
age_levels <- grep("^edad", col_cons, value = TRUE)
esc_levels <- grep("^esco", col_cons, value = TRUE)
sexo_levels<- grep("^sexo", col_cons, value = TRUE)

vars_base <- c("estrato","esc","edad","sexo","e6a","y7")
casen <- casen_raw[, vars_base, drop = FALSE]; rm(casen_raw)
casen$Comuna  <- substr(as.character(casen$estrato), 1, 5); casen$estrato <- NULL
casen$esc  <- as.integer(unclass(casen$esc))
casen$edad <- as.integer(unclass(casen$edad))
casen$e6a  <- as.numeric(unclass(casen$e6a))
casen$sexo <- as.integer(unclass(casen$sexo))
casen$y7   <- as.numeric(unclass(casen$y7))

# Imputación ligera de escolaridad
idx_na <- which(is.na(casen$esc))
if (length(idx_na) > 0) {
  df_fit <- casen[!is.na(casen$esc) & !is.na(casen$e6a), ]
  if (nrow(df_fit) > 5) {
    fit  <- lm(esc ~ e6a, data = df_fit)
    pred <- predict(fit, newdata = casen[idx_na, , drop = FALSE])
    casen$esc[idx_na] <- as.integer(round(pmax(0, pmin(29, pred))))
  }
}

casen$ID <- as.character(seq_len(nrow(casen)))
casen$edad_cat <- cut(casen$edad, breaks=c(0,30,40,50,60,70,80,Inf),
                      labels=age_levels, right=FALSE, include.lowest=TRUE)
casen$esc_cat  <- factor(with(casen,
                              ifelse(esc==0,esc_levels[1],
                                     ifelse(esc<=8,esc_levels[2],
                                            ifelse(esc<=12,esc_levels[3],esc_levels[4])))),
                         levels=esc_levels)
casen$sexo_cat <- factor(ifelse(casen$sexo==2,sexo_levels[1],
                                ifelse(casen$sexo==1,sexo_levels[2],NA)),
                         levels=sexo_levels)
casen$empr <- as.integer(!is.na(casen$y7) & casen$y7 > 0)

################################################################################
## 4) MICROSIMULACIÓN CON rakeR
################################################################################
cons_censo_comunas <- split(cons_censo_df, cons_censo_df$COMUNA)
inds_list          <- split(casen, casen$Comuna)
set.seed(123)

sim_list <- lapply(names(cons_censo_comunas), function(zona){
  cons_i    <- cons_censo_comunas[[zona]]
  col_order <- sort(setdiff(names(cons_i), c("COMUNA","GEOCODIGO")))
  cons_i    <- cons_i[, c("GEOCODIGO", col_order), drop=FALSE]
  tmp <- inds_list[[zona]]; if (is.null(tmp)) return(NULL)
  inds_i <- tmp[, c("ID","edad_cat","esc_cat","sexo_cat"), drop=FALSE]
  names(inds_i) <- c("ID","Edad","Escolaridad","Sexo")
  inds_i <- inds_i[complete.cases(inds_i), , drop=FALSE]
  if (nrow(inds_i)==0) return(NULL)
  w_frac <- weight(cons=cons_i, inds=inds_i, vars=c("Edad","Escolaridad","Sexo"))
  sim_i  <- integerise(weights=w_frac, inds=inds_i, seed=123)
  merge(sim_i, tmp[, c("ID","empr")], by="ID", all.x=TRUE)
})

sim_df <- data.table::rbindlist(Filter(Negate(is.null), sim_list), idcol="COMUNA", fill=TRUE)
zonas_empr <- as.data.table(sim_df)[, .(
  pct_emprendedores = mean(empr, na.rm=TRUE),
  n_emprendedores   = sum(empr, na.rm=TRUE),
  n_poblacion       = .N
), by=.(zone)]
data.table::setnames(zonas_empr, "zone", "geocodigo")
zonas_empr$geocodigo <- as.character(zonas_empr$geocodigo)

################################################################################
## 5) CONEXIÓN Y GEOMETRÍAS DESDE PostgreSQL
################################################################################
norm_str <- function(x) tolower(stringi::stri_trans_general(as.character(x), "Latin-ASCII"))
con <- dbConnect(Postgres(),
                 dbname="censo_rm_2017", host="localhost", port=5432,
                 user="postgres", password="postgres")

zonas_censales_rm <- st_read(con, query="SELECT * FROM dpa.zonas_censales_rm;", quiet=TRUE)
comunas_rm_shp    <- st_read(con, query="SELECT * FROM dpa.comunas_rm_shp;",  quiet=TRUE)
dbDisconnect(con)

names(zonas_censales_rm) <- tolower(names(zonas_censales_rm))
names(comunas_rm_shp)    <- tolower(names(comunas_rm_shp))

zonas_censales_rm <- zonas_censales_rm |>
  mutate(geocodigo = as.character(geocodigo)) |>
  left_join(zonas_empr, by="geocodigo") |>
  mutate(prop_empr = pct_emprendedores)

################################################################################
## 6) FILTRO URBANO Y RECORTE GRAN SANTIAGO
################################################################################
urb_cols <- intersect(c("urbano","es_urbano","urban","zona_urbana","urb"), names(zonas_censales_rm))
if (length(urb_cols)) {
  col_u <- urb_cols[1]
  zonas_censales_rm <- zonas_censales_rm |>
    mutate(.urb_raw = .data[[col_u]], .urb_str = norm_str(.urb_raw)) |>
    filter(.urb_raw %in% c(1, TRUE) | .urb_str %in% c("u","urbano","urban","true","si","s","1"))
}

zonas_censales_rm <- st_make_valid(zonas_censales_rm)
comunas_rm_shp    <- st_make_valid(comunas_rm_shp)
gs_comunas <- comunas_rm_shp |>
  filter(nom_provin == "SANTIAGO" | nom_comuna %in% c("SAN BERNARDO","PUENTE ALTO"))

inter <- suppressWarnings(st_intersection(st_make_valid(zonas_censales_rm),
                                          st_make_valid(gs_comunas)))
inter <- st_collection_extract(inter, "POLYGON")
inter <- inter[!st_is_empty(inter), ]

u_zonas <- st_union(inter)
buf <- tryCatch(st_buffer(st_make_valid(u_zonas), set_units(2000, "m")),
                error = function(e) st_buffer(st_make_valid(u_zonas), 2000))
bb <- st_bbox(buf)
xlim_zoom <- c(bb["xmin"], bb["xmax"])
ylim_zoom <- c(bb["ymin"], bb["ymax"])

comunas_clip <- suppressWarnings(st_intersection(gs_comunas, st_as_sf(u_zonas))) |>
  st_make_valid() |> st_collection_extract("POLYGON")
comunas_clip <- comunas_clip[!st_is_empty(comunas_clip), ] |>
  dplyr::group_by(nom_comuna) |> dplyr::summarise(.groups="drop")

################################################################################
## 7) TEMA Y PALETA
################################################################################
pal_blues <- c("#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#3182bd","#08519c")
theme_joaquín <- function() {
  theme_minimal(base_size = 12) +
    theme(
      panel.grid.major = element_line(color = "grey85", linewidth = 0.3),
      panel.grid.minor = element_blank(),
      axis.text        = element_text(color = "grey30"),
      axis.title       = element_blank(),
      axis.ticks       = element_blank(),
      plot.title       = element_text(face = "bold", size = 14),
      plot.subtitle    = element_text(color = "grey30", size = 11),
      plot.caption     = element_text(size = 8, color = "grey40"),
      legend.position  = "right",
      legend.justification = "center",
      legend.title     = element_text(face = "bold", margin = margin(b = 8)),
      legend.key.height= unit(14, "pt"),
      legend.key.width = unit(10, "pt"),
      plot.margin      = margin(10, 40, 10, 10)
    )
}

################################################################################
## 8) MAPA DE EMPRENDEDORES (%)
################################################################################
inter$prop_pct <- 100 * inter$prop_empr
max_plot <- 18.8

p_empr <- ggplot(inter) +
  geom_sf(aes(fill = prop_pct),
          color = alpha("white", 0.6), linewidth = 0.15) +
  geom_sf(data = comunas_clip, fill = NA,
          color = "grey25", linewidth = 0.45) +
  coord_sf(xlim = xlim_zoom, ylim = ylim_zoom, expand = FALSE,
           label_graticule = "SW", label_axes = "SW") +
  scale_fill_gradientn(colors = pal_blues,
                       limits = c(0, max_plot),
                       oob = squish,
                       name = "% con emprendimientos",
                       breaks = c(0,5,10,15,18.8),
                       labels = function(x) gsub("\\.", ",", sprintf("%.1f", x))) +
  guides(fill = guide_colorbar(barheight = unit(120, "pt"),
                               title.position = "top", title.hjust = 0.5)) +
  labs(title = "Población con actividad emprendedora (%)",
       subtitle = "Zona urbana del Gran Santiago por zona censal",
       caption = "Fuente: CASEN (rakeR) + Censo 2017") +
  theme_joaquín()

ggsave("mapa_emprendedores_urbano.png", p_empr, width = 9, height = 7, dpi = 300)
print(p_empr)

################################################################################
## 9) DISTRIBUCIÓN DE TIPO DE VIVIENDA (CASAS / DEPTOS)
################################################################################
con <- dbConnect(Postgres(),
                 dbname="censo_rm_2017", host="localhost", port=5432,
                 user="postgres", password="postgres")

sql_tipo_viv <- "
WITH base AS (
  SELECT
    z.geocodigo::text AS geocodigo,
    c.nom_comuna,
    v.p01,
    v.p02
  FROM public.viviendas v
  JOIN public.zonas   z ON v.zonaloc_ref_id = z.zonaloc_ref_id
  JOIN public.comunas c ON z.codigo_comuna  = c.codigo_comuna
),
viviendas_validas AS (
  SELECT *
  FROM base
  WHERE p02 = 1  -- solo viviendas particulares ocupadas
),
agg AS (
  SELECT
    geocodigo,
    MAX(nom_comuna) AS nom_comuna,
    COUNT(*) AS total_viv,
    COUNT(*) FILTER (WHERE p01 = 1) AS n_casas,
    COUNT(*) FILTER (WHERE p01 = 2) AS n_deptos
  FROM viviendas_validas
  GROUP BY geocodigo
)
SELECT
  geocodigo,
  nom_comuna,
  ROUND(100.0 * n_casas  / NULLIF(total_viv,0), 2) AS pct_casas,
  ROUND(100.0 * n_deptos / NULLIF(total_viv,0), 2) AS pct_deptos
FROM agg;
"

tbl_viv <- dbGetQuery(con, sql_tipo_viv) %>%
  mutate(geocodigo = as.character(geocodigo))
dbDisconnect(con)

sf_viv <- inter %>%
  mutate(geocodigo = as.character(geocodigo)) %>%
  left_join(tbl_viv, by = "geocodigo")

################################################################################
## 10) MAPAS – % CASAS Y % DEPARTAMENTOS 
################################################################################
p_casas <- ggplot(sf_viv) +
  geom_sf(aes(fill = pct_casas),
          color = alpha("white", 0.6), linewidth = 0.15) +
  geom_sf(data = comunas_clip, fill = NA,
          color = "grey25", linewidth = 0.45) +
  coord_sf(xlim = xlim_zoom, ylim = ylim_zoom, expand = FALSE,
           label_graticule = "SW", label_axes = "SW") +
  scale_fill_gradientn(
    colors = pal_blues,
    limits = c(0, 100),
    oob = squish,
    name = "% de viviendas tipo casa",
    breaks = c(0, 25, 50, 75, 100),
    labels = label_number(accuracy = 1, decimal.mark = ",")
  ) +
  guides(fill = guide_colorbar(barheight = unit(120, "pt"),
                               title.position = "top", title.hjust = 0.5)) +
  labs(title = "Distribución de viviendas tipo casa (%)",
       subtitle = "Zona urbana del Gran Santiago por zona censal",
       caption = "Fuente: Censo 2017, elaboración propia") +
  theme_joaquín()

p_deptos <- ggplot(sf_viv) +
  geom_sf(aes(fill = pct_deptos),
          color = alpha("white", 0.6), linewidth = 0.15) +
  geom_sf(data = comunas_clip, fill = NA,
          color = "grey25", linewidth = 0.45) +
  coord_sf(xlim = xlim_zoom, ylim = ylim_zoom, expand = FALSE,
           label_graticule = "SW", label_axes = "SW") +
  scale_fill_gradientn(
    colors = pal_blues,
    limits = c(0, 100),       # ← fuerza el rango de 0–100%
    oob = squish,             # ← evita cortes si hay valores fuera
    name = "% de viviendas tipo departamento",
    breaks = c(0, 25, 50, 75, 100),   # ← asegura que aparezca 100%
    labels = label_number(accuracy = 1, decimal.mark = ",")
  ) +
  guides(fill = guide_colorbar(barheight = unit(120, "pt"),
                               title.position = "top", title.hjust = 0.5)) +
  labs(title = "Distribución de viviendas tipo departamento (%)",
       subtitle = "Zona urbana del Gran Santiago por zona censal",
       caption = "Fuente: Censo 2017, elaboración propia") +
  theme_joaquín()

ggsave("mapa_viviendas_tipo_casa.png", p_casas, width = 9, height = 7, dpi = 300)
ggsave("mapa_viviendas_tipo_departamento.png", p_deptos, width = 9, height = 7, dpi = 300)

print(p_casas)
print(p_deptos)

################################################################################
## 11) MAPAS BIVARIADOS 3×3 – Emprendedores vs Casas / Departamentos (CORREGIDO)
################################################################################
library(biscale)
library(cowplot)

# Base con las tres variables ya en porcentaje
sf_bi_base <- sf_viv |>
  dplyr::mutate(
    empr_pct   = prop_pct,     # % emprendedores (viene de 'inter')
    casas_pct  = pct_casas,    # % casas
    deptos_pct = pct_deptos    # % deptos
  )

# Helper robusto: recibe nombres de columnas como strings
make_bi <- function(sf_data, var_x, var_y, xlab, ylab, title){
  # crear columnas canon x/y y filtrar NA/Inf
  df_xy <- sf_data |>
    dplyr::mutate(
      x = .data[[var_x]],
      y = .data[[var_y]]
    ) |>
    dplyr::filter(is.finite(x), is.finite(y))
  
  # clasificar en 3×3 cuantiles
  sf_bi <- biscale::bi_class(
    df_xy,
    x = x, y = y,
    dim = 3, style = "quantile"
  )
  
  # mapa principal
  p_map <- ggplot(sf_bi) +
    geom_sf(aes(fill = bi_class),
            color = scales::alpha("white", 0.6),
            linewidth = 0.15,
            show.legend = FALSE) +
    geom_sf(data = comunas_clip, fill = NA,
            color = "grey25", linewidth = 0.45) +
    biscale::bi_scale_fill(pal = "DkBlue", dim = 3) +
    coord_sf(xlim = xlim_zoom, ylim = ylim_zoom, expand = FALSE,
             label_graticule = "SW", label_axes = "SW") +
    labs(
      title    = title,
      subtitle = "Zona urbana del Gran Santiago por zona censal",
      caption  = "Clasificación bivariada (cuantiles 3×3) • Fuente: CASEN (rakeR) + Censo 2017"
    ) +
    theme_joaquín()
  
  # leyenda (texto + overlay de flecha horizontal)
  p_leg <- biscale::bi_legend(
    pal = "DkBlue", dim = 3,
    xlab = xlab,       # ← mantiene texto limpio
    ylab = ylab,       # ← sin flecha, bi_legend ya la dibuja
    size = 10
  )
  
  theme_minimal(base_size = 10) +
    theme(
      panel.grid   = element_blank(),
      axis.text    = element_blank(),
      axis.ticks   = element_blank(),
      axis.title.x = element_text(margin = margin(t = 6)),
      axis.title.y = element_text(margin = margin(r = 6)),
      plot.margin  = margin(6, 6, 6, 6)
    )
  
  # composición mapa + leyenda, con overlay de flecha "→" sobre la leyenda
  composed <- cowplot::ggdraw() +
    cowplot::draw_plot(p_map, x = 0.00, y = 0.00, width = 0.80, height = 1.00) +
    cowplot::draw_plot(p_leg, x = 0.82, y = 0.18, width = 0.18, height = 0.28) +
    # ⟶ Flecha añadida como etiqueta para evitar problemas de Unicode del device
    cowplot::draw_label(
      label = "\u2192",          # → flecha derecha
      x = 0.82 + 0.09,           # centrada dentro del recuadro de la leyenda
      y = 0.18 + 0.02,           # justo debajo del triángulo de la leyenda
      hjust = 0.5, vjust = 0.5,
      size = 10
    )
  
  
  
  # composición mapa + leyenda
  composed <- cowplot::ggdraw() +
    cowplot::draw_plot(p_map, x = 0.00, y = 0.00, width = 0.80, height = 1.00) +
    cowplot::draw_plot(p_leg, x = 0.82, y = 0.18, width = 0.18, height = 0.28)
  
  list(map = p_map, legend = p_leg, composed = composed)
}

# 11.1) Emprendedores vs Casas
bi_casas <- make_bi(
  sf_data = sf_bi_base,
  var_x   = "empr_pct",
  var_y   = "casas_pct",
  xlab    = "% Emprendedores",
  ylab    = "% Casas",
  title   = "% Emprendedores vs. % Casas"
)
ggsave("mapa_bivariado_empr_vs_casas1.png",
       bi_casas$composed, width = 9.5, height = 7.5, dpi = 300)
print(bi_casas$composed)

# 11.2) Emprendedores vs Departamentos
bi_deptos <- make_bi(
  sf_data = sf_bi_base,
  var_x   = "empr_pct",
  var_y   = "deptos_pct",
  xlab    = "% Emprendedores",
  ylab    = "% Departamentos",
  title   = "% Emprendedores vs. % Departamentos"
)
ggsave("mapa_bivariado_empr_vs_deptos1.png",
       bi_deptos$composed, width = 9.5, height = 7.5, dpi = 300)
print(bi_deptos$composed)

################################################################################
## 8BIS) MAPA PORTADA – EMPRENDIMIENTO GRAN SANTIAGO
################################################################################

# Tema específico para portada (fondo azul corporativo, sin ejes ni textos)
theme_portada <- function() {
  theme_void() +
    theme(
      plot.background  = element_rect(fill = "#1C2E46", color = NA),
      panel.background = element_rect(fill = "#1C2E46", color = NA),
      plot.margin      = margin(40, 80, 40, 80)
    )
}

# Mapa de portada usando la tasa de emprendedores
p_portada <- ggplot(inter) +
  # Zonas censales coloreadas por % de emprendedores (sin leyenda)
  geom_sf(aes(fill = prop_pct),
          color = scales::alpha("white", 0.10),
          linewidth = 0.08,
          show.legend = FALSE) +
  # Bordes de comunas para dar estructura
  geom_sf(data = comunas_clip,
          fill = NA,
          color = scales::alpha("white", 0.40),
          linewidth = 0.25) +
  # Enfoque sobre el Gran Santiago
  coord_sf(
    xlim   = xlim_zoom,
    ylim   = ylim_zoom,
    expand = FALSE
  ) +
  # Paleta suave sobre fondo oscuro
  scale_fill_gradientn(
    colours = c("#1C2E46", "#3B6EA8", "#69B3FF"),
    limits  = c(0, max_plot),
    oob     = squish
  ) +
  theme_portada()

# Exportar en formato panorámico para usar como banner en la web
ggsave(
  filename = "mapa_portada_emprendimiento.png",
  plot     = p_portada,
  width    = 16,    # ajusta según necesites
  height   = 5,     # relación horizontal tipo hero
  dpi      = 300
)

print(p_portada)

################################################################################
## 8C) MAPA – DISTRIBUCIÓN DE PROFESIONALES POR ZONA CENSAL (≥16 AÑOS)
################################################################################

library(data.table)

# 1) Vincular ID y zona censal simulada
sim_df_prof <- as.data.table(sim_df)[, .(ID, zone)]
casen_dt    <- as.data.table(casen)[, .(ID, esc)]

# 2) Unir escolaridad de CASEN
sim_df_prof <- merge(sim_df_prof, casen_dt, by = "ID", all.x = TRUE)

# 3) Definir indicador de profesional (≥16 años de escolaridad)
sim_df_prof[, es_prof := ifelse(!is.na(esc) & esc >= 16, 1L, 0L)]

# 4) Agregar por zona censal
zonas_prof <- sim_df_prof[, .(
  pct_profesionales = 100 * mean(es_prof, na.rm = TRUE),
  n_profesionales   = sum(es_prof, na.rm = TRUE),
  n_poblacion       = .N
), by = zone]

setnames(zonas_prof, "zone", "geocodigo")
zonas_prof[, geocodigo := as.character(geocodigo)]

# 5) Unir con zonas urbanas del Gran Santiago (mismo 'inter')
inter_prof <- inter |>
  dplyr::mutate(geocodigo = as.character(geocodigo)) |>
  dplyr::left_join(as.data.frame(zonas_prof), by = "geocodigo")

# 6) Mapa (mismo estilo que emprendedores)
p_prof <- ggplot(inter_prof) +
  geom_sf(aes(fill = pct_profesionales),
          color = alpha("white", 0.6),
          linewidth = 0.15,
          na.rm = TRUE) +
  geom_sf(data = comunas_clip,
          fill = NA,
          color = "grey25",
          linewidth = 0.45) +
  coord_sf(
    xlim   = xlim_zoom,
    ylim   = ylim_zoom,
    expand = FALSE,
    label_graticule = "SW",
    label_axes      = "SW"
  ) +
  scale_fill_gradientn(
    colors = pal_blues,
    limits = c(0, max(inter_prof$pct_profesionales, na.rm = TRUE)),
    oob    = squish,
    name   = "% de población profesional",
    breaks = scales::pretty_breaks(n = 6),
    labels = scales::label_number(accuracy = 1, decimal.mark = ",")
  ) +
  guides(fill = guide_colorbar(
    barheight      = unit(120, "pt"),
    title.position = "top",
    title.hjust    = 0.5
  )) +
  labs(
    title    = "Distribución de profesionales (%)",
    subtitle = "Zona urbana del Gran Santiago por zona censal",
    caption  = "Profesionales: personas con ≥16 años de escolaridad.\nFuente: CASEN (rakeR) + Censo 2017, elaboración propia."
  ) +
  theme_joaquín()

ggsave(
  filename = "mapa_profesionales_urbano_16anios.png",
  plot     = p_prof,
  width    = 9,
  height   = 7,
  dpi      = 300,
  units    = "in",
  device   = "png",
  bg       = "white"
)

print(p_prof)
```

## 2.1 Metodología

Para complementar el análisis espacial y profundizar en la identificación de patrones territoriales, se incorporó un proceso de clusterización aplicado a las zonas censales urbanas del Gran Santiago. Esta etapa metodológica se desarrolló íntegramente en RStudio, utilizando procedimientos estadísticos y técnicas de aprendizaje no supervisado para agrupar territorios con comportamientos socioeconómicos similares.

El análisis se construyó a partir de tres variables clave obtenidas en los trabajos anteriores: el porcentaje de personas con actividad emprendedora (estimada mediante microsimulación CASEN-Censo), el porcentaje de viviendas tipo casa (por consecuencia el análisis contempla el porcentaje de viviendas tipo departamento) y el porcentaje de población profesional definida como personas con ≥16 años de escolaridad. Estas variables fueron estandarizadas para asegurar comparabilidad entre magnitudes y evitar que diferencias de escala influyeran en los resultados del agrupamiento, proceso realizado en entregas anteriores.

### 2.1.1 Algoritmo K-means y método del codo

El algoritmo k-means agrupa observaciones en k clusters mediante un proceso iterativo que minimiza la variabilidad intragrupal. Comienza definiendo k centroides iniciales, asigna cada observación al centroide más cercano y recalcula la posición de los centroides como el promedio de las observaciones asignadas. Este proceso se repite hasta que las asignaciones se estabilizan, produciendo grupos internamente homogéneos y externamente diferenciados.

Para determinar el número óptimo de clusters, se utilizó el método del codo (elbow method), evaluando la variación de la suma de distancias intragrupo (WSS) para distintos valores de *k*. Este procedimiento permitió seleccionar un número adecuado de grupos que capturara la complejidad del fenómeno sin sobreajustarlo.

```{r metodo_codo, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
#################################################################################
## 9) CLUSTERING TRIVARIADO
##    % Emprendedores, % Casas, % Profesionales (≥16 años)
################################################################################

library(dplyr)
library(sf)
library(ggplot2)
library(factoextra)
library(cowplot)

# 9.1) Base para clustering
# - sf_viv contiene pct_casas y proviene de inter
# - inter tiene prop_pct (proporción emprendedores)
# - zonas_prof tiene pct_profesionales (≥16)

sf_cluster <- sf_viv %>%
  dplyr::mutate(
    empr_pct  = prop_pct,   # % población con actividad emprendedora
    casas_pct = pct_casas   # % de viviendas tipo casa
  ) %>%
  dplyr::left_join(
    zonas_prof[, c("geocodigo", "pct_profesionales")],
    by = "geocodigo"
  ) %>%
  dplyr::filter(
    is.finite(empr_pct),
    is.finite(casas_pct),
    is.finite(pct_profesionales)
  )

# 9.2) Matriz de variables para k-means
vars_clusters <- sf_cluster %>%
  sf::st_drop_geometry() %>%
  dplyr::select(
    empr_pct,
    casas_pct,
    pct_profesionales
  )

vars_scaled <- scale(vars_clusters)

# 9.3) Método del codo
set.seed(123)
fviz_nbclust(vars_scaled, kmeans, method = "wss") +
  labs(
    title = "Método del codo",
    x     = "Número de clusters (k)",
    y     = "WSS"
  )

# Define K según el gráfico del codo (ajusta si fuera necesario)
k_opt <- 3

# 9.4) K-means
set.seed(123)
km_tri <- kmeans(vars_scaled, centers = k_opt, nstart = 50)

# Fijar 'cluster' como factor ordenado 1..k y CONSISTENTE
sf_cluster <- sf_cluster %>%
  mutate(cluster = factor(km_tri$cluster,
                          levels = seq_len(k_opt),
                          labels = as.character(seq_len(k_opt))))

# Paleta ÚNICA y NOMBRADA para TODO (coincide con la que ves en tus scatter por defecto)
pal_clusters <- c(
  "1" = "#F8766D",  # rojo/salmón
  "2" = "#00BA38",  # verde
  "3" = "#619CFF"   # azul
)[seq_len(k_opt)]
```

Al analizar el método del codo, se determinó que la cantidad óptima de clusters es tres. A partir de ese punto, la reducción del error (WSS) se vuelve despreciable, de modo que incrementar el número de grupos solo añadiría complejidad al modelo sin aportar una mejora significativa en la capacidad explicativa.

Habiendo definido la cantidad de clusters se ejecutó el modelo de clustering, asignando a cada zona censal un grupo según su perfil combinado de emprendimiento, tipología de vivienda y composición profesional. Este resultado permitió construir una tipología territorial que sintetiza las principales configuraciones urbanas presentes en el Gran Santiago.

### 2.1.2 Índice de Shannon

Para complementar el análisis de clusters, se incorporó el índice de Shannon con el propósito de evaluar la variabilidad interna de cada comuna. Este indicador, ampliamente utilizado en estudios de diversidad, permite cuantificar cuán heterogénea es la composición de clusters dentro de un territorio. Su cálculo se basa en la expresión:

\$\$H=−∑pi​ln(pi​)\$\$

Donde pi corresponde a la proporción de zonas censales de una comuna pertenecientes al cluster i. Valores altos reflejan comunas con una distribución más equilibrada entre distintos perfiles socioeconómicos (mayor heterogeneidad interna), mientras que valores bajos indican comunas dominadas por uno o pocos perfiles (mayor homogeneidad). De esta forma, el índice de Shannon proporciona una medida sintética de la diversidad territorial de cada comuna, permitiendo identificar contrastes internos que no son capturados únicamente por los mapas de clusters.

### 2.1.3 Representación de los resultados

Finalmente, los clusters obtenidos fueron visualizados mediante gráficos de dispersión y mapas temáticos, lo que facilitó la interpretación territorial de los resultados y permitió identificar patrones espaciales coherentes con las dinámicas socioeconómicas de la ciudad. Esta integración entre modelación estadística y cartografía permitió avanzar hacia una lectura más completa y multidimensional de la estructura urbana metropolitana.

------------------------------------------------------------------------

# 3. Resultados y análisis

## 3.1 Gráficos de relación entre variables por cluster

El gráfico evidencia tres comportamientos claramente diferenciados entre las zonas censales del Gran Santiago, lo que reafirma la robustez de la clasificación obtenida mediante k-means. Cada cluster no solo agrupa zonas con niveles similares de emprendimiento, sino que además captura patrones urbanos asociados a la forma de habitar.

### 3.1.1 % Emprendedores vs % Casas

```{r graf1, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
################################################################################
## 10) GRÁFICOS DE RELACIÓN ENTRE VARIABLES
################################################################################

# 10.1) % Emprendedores vs % Casas
g_empr_casas <- ggplot(sf_cluster,
                       aes(x = casas_pct,
                           y = empr_pct,
                           color = cluster)) +
  geom_point(alpha = 0.85, size = 2) +
  scale_color_manual(values = pal_clusters, name = "cluster", drop = FALSE) +
  labs(
    title = "% Emprendedores vs % Casas por cluster",
    x     = "% de viviendas tipo casa",
    y     = "% población con actividad emprendedora"
  ) +
  theme_minimal()

# 10.2) % Emprendedores vs % Profesionales (≥16)
g_empr_prof <- ggplot(sf_cluster,
                      aes(x = pct_profesionales,
                          y = empr_pct,
                          color = cluster)) +
  geom_point(alpha = 0.85, size = 2) +
  scale_color_manual(values = pal_clusters, name = "cluster", drop = FALSE) +
  labs(
    title = "% Emprendedores vs % Profesionales por cluster",
    x     = "% población profesional (≥16 años de escolaridad)",
    y     = "% población con actividad emprendedora"
  ) +
  theme_minimal()

# 10.3) % Casas vs % Profesionales (≥16)
g_casas_prof <- ggplot(sf_cluster,
                       aes(x = casas_pct,
                           y = pct_profesionales,
                           color = cluster)) +
  geom_point(alpha = 0.85, size = 2) +
  scale_color_manual(values = pal_clusters, name = "cluster", drop = FALSE) +
  labs(
    title = "% Casas vs % Profesionales por cluster",
    x     = "% de viviendas tipo casa",
    y     = "% población profesional (≥16 años de escolaridad)"
  ) +
  theme_minimal()

print(g_empr_casas)
```

Este grupo reúne zonas con bajo porcentaje de personas emprendedoras y, al mismo tiempo, una alta proporción de viviendas tipo casa, muchas de ellas superando el 80–90%.

-   Cluster 1: concentra valores bajos de emprendimiento, con una alta proporción de viviendas tipo casa.

<!-- -->

-   Cluster 2: presenta altos niveles de emprendimiento asociados a zonas con menor presencia de casas.

<!-- -->

-   Cluster 3: combina una alta actividad emprendedora con predominio de viviendas tipo casa, mostrando un perfil intermedio.

### 3.1.2 % Emprendedores vs % Profesionales

```{r graf2, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
print(g_empr_prof)
```

El segundo grupo muestra un comportamiento más equilibrado: niveles medianos a altos de emprendimiento junto con una proporción intermedia de viviendas tipo casa (30–70%).

-   Cluster 1: baja presencia emprendedora y profesional, vinculado a zonas unifamiliares tradicionales.

<!-- -->

-   Cluster 2: destaca por una alta población profesional junto a niveles elevados de emprendimiento.

<!-- -->

-   Cluster 3: combina emprendimiento alto con una profesionalización moderada, lo que lo posiciona como un grupo intermedio en el continuo socioeconómico.

### 3.1.3 % Casas vs % Profesionales

```{r graf3, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
print(g_casas_prof)
```

El tercer grupo destaca por tener los mayores niveles de emprendimiento, incluso alcanzando valores superiores al 15%. A diferencia del cluster 1, estas zonas presentan una amplia variabilidad en la proporción de viviendas tipo casa, desde valores muy bajos hasta zonas al 100% de casas. Esto indica que el emprendimiento aquí no depende directamente del tipo de vivienda, sino de características más estructurales del territorio.

-   Cluster 1: altos niveles de viviendas unifamiliares con baja presencia de profesionales.

<!-- -->

-   Cluster 2: predominio de departamentos y alta profesionalización.

<!-- -->

-   Cluster 3: zonas de casas con presencia profesional moderada, evidenciando un perfil mixto y más equilibrado.

## 3.2 Resumen de clusters

-   1  :  Baja población emprendedora, alta presencia de casas, baja presencia de profesionales.

<!-- -->

-   2  :  Alta población emprendedora, baja presencia de casas, alta presencia de profesionales.

<!-- -->

-   3  :  Alta población emprendedora, alta presencia de casas, presencia moderada de profesionales.

## 3.3 Índice de Shannon

```{r indice_shannon, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
################################################################################
## 12) ÍNDICE DE SHANNON POR COMUNA (a partir de los clusters trivariados)
################################################################################

library(dplyr)
library(sf)
library(ggplot2)

## 12.1) Asegurar que cada zona clusterizada tenga su comuna
##       (usamos una unión espacial con gs_comunas)
sf_cluster_com <- sf::st_join(
  sf_cluster,
  gs_comunas[, c("nom_comuna")],  # solo traemos el nombre de comuna
  join = sf::st_within,
  left  = TRUE
)

# Si quieres revisar:
# table(is.na(sf_cluster_com$nom_comuna))

## 12.2) Calcular el índice de Shannon por comuna
#       H = - sum(p_i * log(p_i)), donde p_i es la proporción de zonas
#       de esa comuna que pertenecen a cada cluster.

shannon_df <- sf_cluster_com %>%
  sf::st_drop_geometry() %>%
  dplyr::group_by(nom_comuna, cluster) %>%
  dplyr::summarise(
    n_zonas = n(),           # nº de zonas de esa comuna en ese cluster
    .groups = "drop"
  ) %>%
  dplyr::group_by(nom_comuna) %>%
  dplyr::mutate(
    p       = n_zonas / sum(n_zonas),              # proporción por cluster
    contrib = ifelse(p > 0, -p * log(p), 0)        # término de Shannon
  ) %>%
  dplyr::summarise(
    H_shannon = sum(contrib),                      # índice de Shannon
    .groups   = "drop"
  )

## 12.3) Unir el índice de Shannon a las geometrías comunales del Gran Santiago

gs_comunas_shannon <- gs_comunas %>%
  dplyr::left_join(shannon_df, by = "nom_comuna")

## 12.4) Mapa del índice de Shannon por comuna

p_shannon <- ggplot(gs_comunas_shannon) +
  geom_sf(aes(fill = H_shannon),
          color = "black",          # bordes comunales marcados en negro
          linewidth = 0.4) +
  coord_sf(
    xlim   = xlim_zoom,
    ylim   = ylim_zoom,
    expand = FALSE,
    label_graticule = "SW",
    label_axes      = "SW"
  ) +
  scale_fill_gradientn(
    colours = pal_blues,
    name    = "Índice de Shannon\n(diversidad de clusters)",
    na.value = "grey90"
  ) +
  labs(
    title    = "Diversidad socioeconómica intra-comunal según índice de Shannon",
    subtitle = "Índice de Shannon calculado a partir de clusters de zonas censales",
    caption  = "Fuente: CASEN (rakeR) + Censo 2017, elaboración propia."
  ) +
  theme_joaquín()

ggsave(
  filename = "mapa_shannon_comunas.png",
  plot     = p_shannon,
  width    = 9,
  height   = 7,
  dpi      = 300
)

print(p_shannon)

```

El índice de Shannon permitió medir cuán diversa es la composición interna de cada comuna según los perfiles identificados en el análisis de clusters. Este indicador muestra si dentro de una comuna conviven distintos tipos de territorios o si, por el contrario, su estructura interna es más homogénea.

Los valores más altos se observaron en Independencia, Quinta Normal, Estación Central, Macul, Peñalolén y La Florida. Estas comunas reúnen barrios con características muy distintas entre sí: zonas tradicionales, áreas densificadas, sectores con presencia de profesionales y otros con mayor actividad comercial o barrial. Esa mezcla hace que sus territorios sean más variados y dinámicos.

Por el contrario, comunas como San Joaquín, San Ramón, Providencia, Conchalí y Cerro Navia muestran baja diversidad interna. Esto significa que la mayor parte de sus zonas censales se parecen entre sí. En Providencia, esta homogeneidad se vincula a su fuerte especialización en viviendas en altura y servicios profesionales; mientras que en comunas como San Ramón o Conchalí predomina una estructura residencial más uniforme y con menor diversificación económica.

En síntesis, el índice de Shannon ayuda a entender no solo cómo son las comunas entre sí, sino también qué tan diversas son hacia adentro. Las comunas con mayor mezcla interna tienden a combinar distintos modos de vivir y emprender, mientras que las más homogéneas presentan un perfil territorial más claro y definido.

## 3.4 Mapa de Clusters

```{r mapa_clusters, echo=TRUE, fig.height=8, fig.width=13, message=FALSE, warning=FALSE}
################################################################################
## 11) MAPA DE CLUSTERS (con leyenda descriptiva separada)
################################################################################

mapa_clusters_tri <- ggplot(sf_cluster) +
  geom_sf(aes(fill = cluster),
          color = alpha("white", 0.6),   # bordes blancos entre zonas
          linewidth = 0.15) +
  geom_sf(data = comunas_clip,
          fill = NA,
          color = "grey25",
          linewidth = 0.45) +
  coord_sf(
    xlim   = xlim_zoom,
    ylim   = ylim_zoom,
    expand = FALSE,
    label_graticule = "SW",
    label_axes      = "SW"
  ) +
  
  # LEYENDA DESCRIPTIVA (con saltos y separación)
  scale_fill_manual(
    values = pal_clusters,
    breaks = c("1", "2", "3"),
    labels = c(
      "Cluster 1: Baja actividad emprendedora,\nalta presencia de casas,\nbaja presencia de profesionales\n",
      "Cluster 2: Alta actividad emprendedora,\nbaja presencia de casas,\nalta presencia de profesionales\n",
      "Cluster 3: Alta actividad emprendedora,\nalta presencia de casas,\npresencia moderada de profesionales"
    ),
    name   = "Perfiles territoriales",
    drop   = FALSE
  ) +
  
  labs(
    title    = "Clusters según emprendimiento, tipología de vivienda y profesionales",
    subtitle = "Zona urbana del Gran Santiago por zona censal",
    caption  = "Fuente: CASEN (rakeR) + Censo 2017, elaboración propia."
  ) +
  
  theme_joaquín() +
  theme(
    legend.spacing.y = unit(14, "pt"),       # espacio extra entre clusters
    legend.text      = element_text(lineheight = 1.1, size = 10)  # se ve más limpio
  )

print(mapa_clusters_tri)

ggsave(
  filename = "mapa_clusters_empr_tipologia_profesionales_16anios.png",
  plot     = mapa_clusters_tri,
  width    = 9,
  height   = 7,
  dpi      = 300
)

```

El análisis trivariado revela cómo el emprendimiento en el Gran Santiago se organiza de manera desigual según el tipo de vivienda y la composición profesional de la población. Los tres grupos identificados reflejan distintos modos de habitar y de generar actividad económica dentro del territorio metropolitano.

El primer grupo se concentra principalmente en el sur-oriente y nor-poniente del Gran Santiago, abarcando comunas como San Bernardo, El Bosque, La Pintana, Puente Alto, Lo Espejo, Cerro Navia, Pudahuel, Renca, Lo Prado, Quilicura y en algunas zonas de La Florida y Peñalolén. Se caracteriza por una baja proporción de población profesional, una alta presencia de viviendas tipo casa y niveles reducidos de emprendimiento formal. En estos sectores, el emprendimiento surge de forma más doméstica e informal, como respuesta a la falta de empleo asalariado estable, evidenciando estrategias locales de subsistencia y una fuerte dependencia del entorno comunitario.

El segundo grupo, ubicado en el eje centro-oriente, comprende comunas como Providencia, Ñuñoa, Santiago, Las Condes y Vitacura, donde existe una alta proporción de población profesional, mayor presencia de vivienda tipo departamento y niveles elevados de emprendimiento formal y especializado. Aquí, la actividad emprendedora se asocia a servicios profesionales, tecnológicos o de gestión, frecuentemente desvinculados del espacio doméstico y apoyados en redes laborales y de conocimiento. Se trata de un emprendimiento urbano consolidado, inserto en una economía de servicios basada en capital humano.

Finalmente, el tercer grupo se extiende en comunas intermedias y consolidadas, como Pedro Aguirre Cerda, San Joaquín, Quinta Normal, Estación Central, Independencia, San Ramón y La Cisterna, y algunas zonas de comunas periféricas como Maipú y Huechuraba, donde coexisten altos niveles de emprendimiento, predominio de viviendas tipo casa y una presencia moderada de profesionales. En estos territorios, el tejido urbano tradicional y la posibilidad de combinar vivienda con actividad económica permiten la aparición de microemprendimientos barriales, talleres y comercios de proximidad. Este patrón representa una economía intermedia: ni totalmente informal ni plenamente profesionalizada, pero con una fuerte base territorial y comunitaria.

La distribución espacial de los clusters es coherente con los patrones observados en el Trabajo 2, ya que reproduce y combina de manera consistente las tendencias mostradas previamente en los mapas individuales de emprendimiento, tipología de vivienda y población profesional. La principal ventaja del proceso de clusterización es que permite integrar simultáneamente múltiples variables, en este caso, tres dimensiones clave del territorio, superando las limitaciones de los mapas bivariados, que solo permiten analizar dos variables a la vez. Esto ofrece una representación más completa y permite explicar un fenómeno complejo de manera sencilla, agrupando zonas que comparten perfiles socioeconómicos similares. Además, conocer la distribución territorial de estos grupos tiene claras utilidades prácticas: por ejemplo, permite identificar sectores donde sería pertinente incentivar ferias de emprendimiento, ya sea para apoyar zonas con alto emprendimiento informal o para suplir la falta de espacios disponibles en áreas densamente pobladas con predominio de departamentos. En conjunto, este enfoque facilita diseñar intervenciones más precisas y ajustadas a las necesidades de cada territorio.

En conjunto, los resultados muestran que la distribución del emprendimiento en el Gran Santiago no es homogénea, sino que responde a la interacción entre la estructura residencial, el nivel profesional de la población y las oportunidades del entorno urbano. Mientras los sectores centro-oriente concentran un emprendimiento formal y profesionalizado, las zonas sur-oriente y nor-poniente evidencian una economía popular e informal, basada en estrategias comunitarias de sustento. Por su parte, los territorios intermedios representan un punto de equilibrio, donde la vivienda aún cumple un rol productivo y se mantiene una forma híbrida de emprendimiento, que combina cercanía y flexibilidad.

------------------------------------------------------------------------

# 4. Conclusión

Las conclusiones de este trabajo muestran que la integración entre CASEN y Censo 2017 mediante microsimulación, combinada con técnicas de análisis espacial, clustering k-means e índice de Shannon, permite pasar desde una descripción aislada de variables hacia una lectura territorial integrada del emprendimiento en el Gran Santiago. En vez de observar por separado los mapas de emprendedores, tipo de vivienda o población profesional, el análisis trivariado sintetiza estas dimensiones en perfiles territoriales coherentes y comparables, capturando tanto las diferencias entre comunas como la diversidad interna de cada una de ellas.

Los resultados evidencian que el emprendimiento no se distribuye de forma homogénea, sino que se organiza en tres grandes configuraciones: territorios con baja presencia emprendedora y profesional, pero alta proporción de viviendas tipo casa; zonas centro-oriente con alta profesionalización, predominio de departamentos y emprendimiento formal especializado; y un grupo intermedio donde coexisten altos niveles de emprendimiento, predominio de casas y profesionalización moderada. Estos patrones son consistentes con lo observado en los trabajos anteriores a partir de los mapas individuales de cada variable, pero el enfoque de clusterización permite reunirlos en una tipología territorial más clara y fácil de interpretar.

Desde una perspectiva aplicada, conocer la distribución espacial de estos grupos ofrece insumos concretos para la planificación y el diseño de políticas públicas. Por ejemplo, permite identificar sectores donde sería pertinente incentivar ferias de emprendimiento y dispositivos de apoyo en barrios con alta probabilidad de emprendimiento informal, así como detectar áreas densamente pobladas con predominio de departamentos donde existen altos niveles de emprendimiento formal pero escasez de espacios físicos para su desarrollo. De este modo, el trabajo no solo aporta a la comprensión académica del fenómeno, sino que entrega una herramienta útil para orientar intervenciones diferenciadas según las oportunidades y restricciones que impone la estructura urbana de cada territorio.
